# Olaris Testing - Specification

## Objective
Define and standardize the execution of Nuvolaris installation tests on k3s clusters via `ops testing run`, ensuring:
- explicit and verifiable prerequisites;
- complete cleanup of demo objects created by tests;
- consistency of SeaweedFS check with actual cluster protocol.

## Baseline Operations (from README)
- Primary execution: `./run.sh "*.example.com"` or `ops testing run "https://<apihost>"` in the project directory.
- Required tools: `kubectl`, `ops`, with access to the `nuvolaris` namespace.
- Network verification toward API host and Kubernetes API server.

## New Mandatory Prerequisites
Before any test run, the following prerequisites must be satisfied:
- `OPS_BRANCH=main`
- `ops config apihost`
- `ops config slim` (when testing a slim cluster)
- presence of configuration file: `.ops/tmp/config`

If any prerequisite is missing, the run must fail explicitly with a clear message.

## Requirement: Clean Task in `ops testing run`
A dedicated `clean` task must be introduced to remove all demo objects generated by tests (demo users, demo packages/actions, test runtime resources, and any other artifacts created during verification).

### Required Behavior
- The `clean` task must be executable on-demand.
- The `clean` task must be executed automatically at the end of each test run.
- The `clean` must be idempotent (repeatable without blocking errors if objects do not exist).
- In case of test errors, `clean` must still be attempted in the final phase.

## Requirement: Fix SeaweedFS Protocol Check
The SeaweedFS check must not force `https` always.

### Required Behavior
- The protocol (`http`/`https`) must be inferred from cluster configuration.
- The source of truth is `ops config status`.
- If SeaweedFS configuration shows `http` (default cluster), the test must use `http`.
- If it shows `https`, the test must use `https`.
- In the absence of reliable information, the test must log fallback and adopted behavior.

## Change Log (Process)
Every modification implemented from this specification must be recorded as a change log in `agent.md`.

## Acceptance Criteria
- `ops testing run` includes the `clean` task invocable separately.
- At the end of the complete run, no demo objects remain in the target cluster.
- The SeaweedFS check respects the configured protocol and does not fail due to `https` enforcement on `http` clusters.
- The prerequisites listed above are verified before test startup.
- Every modification is tracked in `agent.md`.

